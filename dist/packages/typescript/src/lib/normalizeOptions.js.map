{"version":3,"sources":["../../../../../packages/typescript/src/lib/normalizeOptions.ts"],"sourcesContent":["import ts from 'typescript';\nimport { Compiler } from 'webpack';\nimport get from 'lodash.get';\nimport path from 'path';\n\nimport type { FederatedTypesPluginOptions } from '../types';\n\nimport {\n  TYPESCRIPT_COMPILED_FOLDER_NAME,\n  TYPESCRIPT_FOLDER_NAME,\n  TYPES_INDEX_JSON_FILE_NAME,\n} from '../constants';\n\nexport type NormalizeOptions = ReturnType<typeof normalizeOptions>;\n\nconst defaultOptions: Required<\n  Omit<FederatedTypesPluginOptions, 'federationConfig'>\n> = {\n  compiler: 'tsc',\n  disableDownloadingRemoteTypes: false,\n  disableTypeCompilation: false,\n  typescriptFolderName: TYPESCRIPT_FOLDER_NAME,\n  typescriptCompiledFolderName: TYPESCRIPT_COMPILED_FOLDER_NAME,\n  additionalFilesToCompile: [],\n  downloadRemoteTypesTimeout: 2000,\n};\n\nexport const normalizeOptions = (\n  options: FederatedTypesPluginOptions,\n  compiler: Compiler\n) => {\n  const webpackCompilerOptions = compiler.options;\n\n  const { context, watchOptions } = webpackCompilerOptions;\n  const {\n    federationConfig,\n    typescriptFolderName,\n    typescriptCompiledFolderName,\n    ...restOptions\n  } = {\n    ...defaultOptions,\n    ...options,\n  };\n\n  const federationFileName = federationConfig.filename as string;\n  const distPath =\n    get(webpackCompilerOptions, 'devServer.static.directory') ||\n    get(webpackCompilerOptions, 'output.path') ||\n    'dist';\n\n  const typesPath = federationFileName.substring(\n    0,\n    federationFileName.lastIndexOf('/')\n  );\n\n  const typesIndexJsonFilePath = path.join(\n    typesPath,\n    TYPES_INDEX_JSON_FILE_NAME\n  );\n\n  const distDir = path.join(distPath, typesPath, typescriptFolderName);\n\n  const tsCompilerOptions: ts.CompilerOptions = {\n    declaration: true,\n    emitDeclarationOnly: true,\n    outDir: path.join(distDir, `/${typescriptCompiledFolderName}/`),\n    noEmit: false,\n  };\n\n  const webpackPublicPath = webpackCompilerOptions.output.publicPath;\n\n  const publicPath =\n    typeof webpackPublicPath === 'string'\n      ? webpackPublicPath === 'auto'\n        ? ''\n        : webpackPublicPath\n      : '';\n\n  const watchOptionsToIgnore = [\n    path.normalize(path.join(context as string, typescriptFolderName)),\n  ];\n\n  const ignoredWatchOptions = Array.isArray(watchOptions.ignored)\n    ? [...watchOptions.ignored, ...watchOptionsToIgnore]\n    : watchOptionsToIgnore;\n\n  return {\n    ...restOptions,\n    distDir,\n    publicPath,\n    tsCompilerOptions,\n    typesIndexJsonFileName: TYPES_INDEX_JSON_FILE_NAME,\n    typesIndexJsonFilePath,\n    typescriptFolderName,\n    webpackCompilerOptions,\n    ignoredWatchOptions,\n  };\n};\n"],"names":["normalizeOptions","defaultOptions","compiler","disableDownloadingRemoteTypes","disableTypeCompilation","typescriptFolderName","TYPESCRIPT_FOLDER_NAME","typescriptCompiledFolderName","TYPESCRIPT_COMPILED_FOLDER_NAME","additionalFilesToCompile","downloadRemoteTypesTimeout","options","webpackCompilerOptions","context","watchOptions","federationConfig","restOptions","federationFileName","filename","distPath","get","typesPath","substring","lastIndexOf","typesIndexJsonFilePath","path","join","TYPES_INDEX_JSON_FILE_NAME","distDir","tsCompilerOptions","declaration","emitDeclarationOnly","outDir","noEmit","webpackPublicPath","output","publicPath","watchOptionsToIgnore","normalize","ignoredWatchOptions","Array","isArray","ignored","typesIndexJsonFileName"],"mappings":";;;;+BA2BaA;;;eAAAA;;;;;;oEAzBG;+DACC;2BAQV;AAIP,MAAMC,iBAEF;IACFC,UAAU;IACVC,+BAA+B,KAAK;IACpCC,wBAAwB,KAAK;IAC7BC,sBAAsBC,iCAAsB;IAC5CC,8BAA8BC,0CAA+B;IAC7DC,0BAA0B,EAAE;IAC5BC,4BAA4B;AAC9B;AAEO,MAAMV,mBAAmB,CAC9BW,SACAT,WACG;IACH,MAAMU,yBAAyBV,SAASS,OAAO;IAE/C,MAAM,EAAEE,QAAO,EAAEC,aAAY,EAAE,GAAGF;IAClC,MAKI,OAAA,eACCX,gBACAU,UAPC,EACJI,iBAAgB,EAChBV,qBAAoB,EACpBE,6BAA4B,EAE7B,GAAG,MADCS,iDACD;QAJFD;QACAV;QACAE;;IAOF,MAAMU,qBAAqBF,iBAAiBG,QAAQ;IACpD,MAAMC,WACJC,IAAAA,kBAAG,EAACR,wBAAwB,iCAC5BQ,IAAAA,kBAAG,EAACR,wBAAwB,kBAC5B;IAEF,MAAMS,YAAYJ,mBAAmBK,SAAS,CAC5C,GACAL,mBAAmBM,WAAW,CAAC;IAGjC,MAAMC,yBAAyBC,aAAI,CAACC,IAAI,CACtCL,WACAM,qCAA0B;IAG5B,MAAMC,UAAUH,aAAI,CAACC,IAAI,CAACP,UAAUE,WAAWhB;IAE/C,MAAMwB,oBAAwC;QAC5CC,aAAa,IAAI;QACjBC,qBAAqB,IAAI;QACzBC,QAAQP,aAAI,CAACC,IAAI,CAACE,SAAS,CAAC,CAAC,EAAErB,6BAA6B,CAAC,CAAC;QAC9D0B,QAAQ,KAAK;IACf;IAEA,MAAMC,oBAAoBtB,uBAAuBuB,MAAM,CAACC,UAAU;IAElE,MAAMA,aACJ,OAAOF,sBAAsB,WACzBA,sBAAsB,SACpB,KACAA,iBAAiB,GACnB,EAAE;IAER,MAAMG,uBAAuB;QAC3BZ,aAAI,CAACa,SAAS,CAACb,aAAI,CAACC,IAAI,CAACb,SAAmBR;KAC7C;IAED,MAAMkC,sBAAsBC,MAAMC,OAAO,CAAC3B,aAAa4B,OAAO,IAC1D;WAAI5B,aAAa4B,OAAO;WAAKL;KAAqB,GAClDA,oBAAoB;IAExB,OAAO,eACFrB;QACHY;QACAQ;QACAP;QACAc,wBAAwBhB,qCAA0B;QAClDH;QACAnB;QACAO;QACA2B;;AAEJ"}