# åŠ è½½åº”ç”¨

æœ¬ç« å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ `createRemoteAppComponent` åœ¨å®¿ä¸»åº”ç”¨ä¸­åŠ è½½å’Œé›†æˆè¿œç¨‹ React åº”ç”¨ã€‚

## ä»€ä¹ˆæ˜¯ createRemoteAppComponentï¼Ÿ

`createRemoteAppComponent` æ˜¯ React Bridge çš„æ ¸å¿ƒ APIï¼Œç”¨äºåœ¨å®¿ä¸»åº”ç”¨ä¸­åŠ è½½è¿œç¨‹ React åº”ç”¨ã€‚å®ƒå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

- **ğŸš€ è‡ªåŠ¨æ‡’åŠ è½½** - è¿œç¨‹åº”ç”¨ä¼šåœ¨éœ€è¦æ—¶æ‰å¼€å§‹åŠ è½½
- **ğŸ”§ ç”Ÿå‘½å‘¨æœŸç®¡ç†** - è‡ªåŠ¨å¤„ç†ç»„ä»¶çš„æŒ‚è½½å’Œå¸è½½
- **ğŸ›£ï¸ è·¯ç”±é›†æˆ** - æ— ç¼é›†æˆ React Routerï¼Œæ”¯æŒ basename æ³¨å…¥
- **âš¡ é”™è¯¯å¤„ç†** - å†…ç½®åŠ è½½å¤±è´¥å’Œè¿è¡Œæ—¶é”™è¯¯å¤„ç†æœºåˆ¶
- **ğŸ¨ æ ·å¼éš”ç¦»** - æ”¯æŒç»„ä»¶çº§æ ·å¼å’Œç±»åé…ç½® 


## å®‰è£…

import { PackageManagerTabs } from '@theme';

<PackageManagerTabs
  command={{
    npm: 'npm install @module-federation/bridge-react@latest',
    yarn: 'yarn add @module-federation/bridge-react@latest',
    pnpm: 'pnpm add @module-federation/bridge-react@latest',
  }}
/>
## åŸºæœ¬ä½¿ç”¨

### æ­¥éª¤ 1: é…ç½®è¿œç¨‹æ¨¡å—

åœ¨å®¿ä¸»åº”ç”¨çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œæ·»åŠ è¿œç¨‹åº”ç”¨çš„é…ç½®ï¼š

:::tip æ„å»ºå·¥å…·æ”¯æŒ
ä»¥ä¸‹ç¤ºä¾‹ä½¿ç”¨ Rsbuild é…ç½®ï¼Œè¯·æ ¹æ®æ‚¨ä½¿ç”¨çš„æ„å»ºå·¥å…·è¿›è¡Œç›¸åº”è°ƒæ•´ï¼š
- **Rsbuild**: `@module-federation/rsbuild-plugin`
- **Rspack**: `@module-federation/enhanced/rspack`
- **Webpack**: `@module-federation/enhanced/webpack`
- **Vite**: `@module-federation/vite`

:::


```ts
// rsbuild.config.ts
import { pluginModuleFederation } from '@module-federation/rsbuild-plugin';
import { defineConfig } from '@rsbuild/core';

export default defineConfig({
  plugins: [
    pluginModuleFederation({
      name: 'host-app',
      remotes: {
        'remote1': 'remote1@http://localhost:3001/remoteEntry.js',
      },
    }),
  ],
});
```

### æ­¥éª¤ 2: åˆ›å»ºè¿œç¨‹ç»„ä»¶

#### 2.1 å®šä¹‰åŠ è½½å’Œé”™è¯¯ç»„ä»¶

é¦–å…ˆï¼Œåˆ›å»ºåŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†ç»„ä»¶ï¼š

```tsx
// ./src/components/RemoteComponents.tsx
import React from 'react';

// åŠ è½½çŠ¶æ€ç»„ä»¶
export const LoadingComponent = () => (
  <div style={{ padding: '20px', textAlign: 'center' }}>
    <div>è¿œç¨‹åº”ç”¨åŠ è½½ä¸­...</div>
  </div>
);

// é”™è¯¯å›é€€ç»„ä»¶
export const ErrorFallback = ({ error }: { error: Error }) => (
  <div style={{ padding: '20px', border: '1px solid #ff6b6b', borderRadius: '8px' }}>
    <h3>è¿œç¨‹åº”ç”¨åŠ è½½å¤±è´¥</h3>
    <p>é”™è¯¯è¯¦æƒ…: {error.message}</p>
    <button onClick={() => window.location.reload()}>
      é‡æ–°åŠ è½½é¡µé¢
    </button>
  </div>
);
```

#### 2.2 åˆ›å»ºè¿œç¨‹åº”ç”¨ç»„ä»¶

ä½¿ç”¨ `createRemoteAppComponent` åˆ›å»ºè¿œç¨‹ç»„ä»¶ï¼š

```tsx
// ./src/remotes/Remote1App.tsx
import { createRemoteAppComponent } from '@module-federation/bridge-react';
import { loadRemote } from '@module-federation/runtime';
import { LoadingComponent, ErrorFallback } from '../components/RemoteComponents';

export const Remote1App = createRemoteAppComponent({
  loader: () => loadRemote('remote1/export-app'),
  loading: LoadingComponent,
  fallback: ErrorFallback,
});
```

#### 2.3 ä¸»åº”ç”¨è·¯ç”±é…ç½®

åœ¨ä¸»åº”ç”¨ä¸­é…ç½®è·¯ç”±ï¼š

```tsx
// ./src/App.tsx
import React from 'react';
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import { Remote1App } from './remotes/Remote1App';

// å®¿ä¸»åº”ç”¨é¦–é¡µç»„ä»¶
const HomePage = () => (
  <div style={{ padding: '20px' }}>
    <h1>å®¿ä¸»åº”ç”¨é¦–é¡µ</h1>
    <p>è¿™æ˜¯å®¿ä¸»åº”ç”¨çš„é¦–é¡µå†…å®¹</p>
  </div>
);

const App = () => {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/" element={<HomePage />} />
        <Route
          path="/remote1/*"
          // ä½¿ç”¨ Remote1App ç»„ä»¶, å°†ä¼šè¢«æ‡’åŠ è½½
          Component={() => (
            <Remote1App
              // å¯è®¾ç½® className å’Œ style æ ·å¼ï¼Œå°†è‡ªåŠ¨æ³¨å…¥åˆ°ç»„ä»¶ä¸Š
              className={styles.remote1}
              style={{ color: 'red' }}
              // name å’Œ age ä¸ºè¿œç¨‹ç»„ä»¶ props, å°†è‡ªåŠ¨é€ä¼ åˆ°è¿œç¨‹ç»„ä»¶
              name={'Ming'}
              age={12}
              // å¯è®¾ç½® ref, å°†è‡ªåŠ¨è½¬å‘åˆ°è¿œç¨‹ç»„ä»¶ï¼Œå¯è·å– ref å¯¹è±¡æ“ä½œ dom
              ref={ref}
            />
          )}
        />
      </Routes>
    </BrowserRouter>
  );
};

export default App;
```

## è¿œç¨‹ç»„ä»¶ Props

### è·¯ç”±ç›¸å…³å±æ€§

- **`basename`**: è®¾ç½®è¿œç¨‹åº”ç”¨çš„åŸºç¡€è·¯å¾„
- **`memoryRoute`**: å†…å­˜è·¯ç”±é…ç½®ï¼Œç”¨äºå°†å­åº”ç”¨è·¯ç”±ä½œä¸º memoryRouter æ§åˆ¶

### æ ·å¼å±æ€§

- **`style`**: React.CSSProperties - è®¾ç½®ç»„ä»¶æ ·å¼
- **`className`**: string - è®¾ç½®ç»„ä»¶ç±»å

### å¼•ç”¨æ”¯æŒ

- **`ref`**: React.Ref\<HTMLDivElement\> - è½¬å‘å¼•ç”¨åˆ°å†…éƒ¨å®¹å™¨å…ƒç´ ï¼Œå¯ç”¨äº DOM æ“ä½œ

### æ•°æ®ä¼ é€’

- **`props`**: ä¼ é€’ç»™è¿œç¨‹ç»„ä»¶çš„å±æ€§å¯¹è±¡
- æˆ–è€…ç›´æ¥ä¼ é€’å±æ€§ï¼Œå¦‚ `userId={'123'}`

## createRemoteAppComponent API å‚è€ƒ

### å‡½æ•°ç­¾å

```tsx
function createRemoteAppComponent<T = Record<string, unknown>, E extends keyof T = keyof T>(
  config: RemoteComponentParams<T, E>
): React.ForwardRefExoticComponent<
  Omit<RemoteComponentProps<T>, "ref"> & React.RefAttributes<HTMLDivElement>
>
```

#### RemoteComponentParams\<T, E\>

é…ç½®å‚æ•°æ¥å£ï¼š

```tsx
interface RemoteComponentParams<T = Record<string, unknown>, E extends keyof T = keyof T> {
  // è¿œç¨‹æ¨¡å—åŠ è½½å™¨
  loader: () => Promise<T>;
  
  // åŠ è½½çŠ¶æ€æ˜¾ç¤ºå†…å®¹
  loading: React.ReactNode;
  
  // é”™è¯¯å›é€€ç»„ä»¶
  fallback: React.ComponentType<{ error: Error }>;
  
  // å¯¼å‡ºåç§°ï¼ˆå¯é€‰ï¼‰
  export?: E;
  
  // ä¼ é€’ç»™è¿œç¨‹ç»„ä»¶çš„å±æ€§ï¼ˆå¯é€‰ï¼‰
  props?: T;
}
```

#### RemoteComponentProps\<T\>

è¿”å›ç»„ä»¶çš„å±æ€§æ¥å£ï¼š

```tsx
interface RemoteComponentProps<T = Record<string, unknown>> {
  // ä¼ é€’ç»™è¿œç¨‹ç»„ä»¶çš„å±æ€§
  props?: T;
  
  // é”™è¯¯å›é€€ç»„ä»¶
  fallback?: React.ComponentType<{ error: Error }>;
  
  // åŠ è½½çŠ¶æ€æ˜¾ç¤ºå†…å®¹
  loading?: React.ReactNode;
  
  // è·¯ç”±åŸºç¡€è·¯å¾„
  basename?: string;
  
  // å†…å­˜è·¯ç”±é…ç½®
  memoryRoute?: {
    entryPath: string;
    initialState?: Record<string, unknown>;
  };
  
  // æ ·å¼å±æ€§
  style?: React.CSSProperties;
  className?: string;
  
  // å…¶ä»–è‡ªå®šä¹‰å±æ€§
  [key: string]: unknown;
}
```

### å‚æ•°è¯¦è§£

#### loader

- **ç±»å‹**: `() => Promise<T>`
- **å¿…éœ€**: æ˜¯
- **ä½œç”¨**: ç”¨äºåŠ è½½è¿œç¨‹æ¨¡å—çš„å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ª Promiseï¼Œè¯¥ Promise è§£æä¸ºè¿œç¨‹æ¨¡å—å¯¹è±¡
- **ç¤ºä¾‹**:
  ```tsx
  loader: () => loadRemote('remote1/export-app')
  loader: () => import('remote1/export-app')
  ```

#### loading

- **ç±»å‹**: `React.ReactNode`
- **å¿…éœ€**: æ˜¯
- **ä½œç”¨**: åœ¨è¿œç¨‹åº”ç”¨åŠ è½½æœŸé—´æ˜¾ç¤ºçš„åŠ è½½å†…å®¹ï¼Œå¯ä»¥æ˜¯ç»„ä»¶ã€å…ƒç´ æˆ–å­—ç¬¦ä¸²
- **ç¤ºä¾‹**:
  ```tsx
  loading: <div>Loading...</div>
  loading: 'Loading remote app...'
  loading: <Spinner />
  ```

#### fallback

- **ç±»å‹**: `React.ComponentType<{ error: Error }>`
- **å¿…éœ€**: æ˜¯
- **ä½œç”¨**: å½“è¿œç¨‹åº”ç”¨åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºçš„é”™è¯¯å›é€€ç»„ä»¶ï¼Œä¼šæ¥æ”¶é”™è¯¯å¯¹è±¡ä½œä¸º `error` å±æ€§
- **ç¤ºä¾‹**:
  ```tsx
  fallback: ({ error }) => <div>Error: {error.message}</div>
  fallback: ErrorBoundaryComponent
  ```

#### export

- **ç±»å‹**: `E extends keyof T` (æ³›å‹çº¦æŸï¼Œé€šå¸¸æ˜¯ `string`)
- **å¿…éœ€**: å¦
- **é»˜è®¤å€¼**: `'default'`
- **ä½œç”¨**: æŒ‡å®šè¦ä½¿ç”¨çš„è¿œç¨‹æ¨¡å—å¯¼å‡ºåç§°
- **ç¤ºä¾‹**:
  
  å‡è®¾è¿œç¨‹æ¨¡å—æœ‰ä»¥ä¸‹å¯¼å‡ºï¼š
  ```tsx
  // è¿œç¨‹æ¨¡å—çš„å¯¼å‡º
  export default App;           // é»˜è®¤å¯¼å‡º
  export const provider = App;  // å‘½åå¯¼å‡º provider
  export const dashboard = Dashboard; // å‘½åå¯¼å‡º dashboard
  ```
  
  åœ¨å®¿ä¸»åº”ç”¨ä¸­å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š
  ```tsx
  // ä½¿ç”¨é»˜è®¤å¯¼å‡ºï¼ˆå¯ä»¥çœç•¥ export å‚æ•°ï¼‰
  createRemoteAppComponent({
    loader: () => loadRemote('remote1/export-app'),
    // export: 'default' // å¯ä»¥çœç•¥ï¼Œé»˜è®¤å°±æ˜¯ 'default'
  })
  
  // ä½¿ç”¨å‘½åå¯¼å‡º provider
  createRemoteAppComponent({
    loader: () => loadRemote('remote1/export-app'),
    export: 'provider'
  })
  
  // ä½¿ç”¨å‘½åå¯¼å‡º dashboard
  createRemoteAppComponent({
    loader: () => loadRemote('remote1/export-app'),
    export: 'dashboard'
  })
  ```


## Bundle ä½“ç§¯ä¼˜åŒ–

### React Router ä¾èµ–è¯´æ˜

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`@module-federation/bridge-react` ä¼šå°† `react-router-dom` æ‰“åŒ…åˆ°ä½ çš„ bundle ä¸­ï¼Œè¿™æ˜¯ä¸ºäº†æä¾›ä»¥ä¸‹å¼€ç®±å³ç”¨çš„èƒ½åŠ›ï¼š

- âœ… è‡ªåŠ¨ basename æ³¨å…¥ - æ— éœ€æ‰‹åŠ¨é…ç½®è·¯ç”±åŸºç¡€è·¯å¾„
- âœ… è·¯ç”±ä¸Šä¸‹æ–‡ä¼ é€’ - è‡ªåŠ¨å¤„ç† React Router ä¸Šä¸‹æ–‡
- âœ… åµŒå¥—è·¯ç”±æ”¯æŒ - å®Œæ•´çš„è·¯ç”±é›†æˆèƒ½åŠ›

**ä½†æ˜¯**ï¼Œå¦‚æœä½ çš„é¡¹ç›®æ»¡è¶³ä»¥ä¸‹ä»»ä¸€æ¡ä»¶ï¼š
- ä¸éœ€è¦è·¯ç”±åŠŸèƒ½ï¼ˆçº¯ç»„ä»¶åŠ è½½ï¼‰
- ä½¿ç”¨é react-router çš„è·¯ç”±æ¡†æ¶ï¼ˆå¦‚ TanStack Routerï¼‰
- å¸Œæœ›æœ€å°åŒ– bundle ä½“ç§¯

**å»ºè®®å…³é—­** `enableBridgeRouter` é…ç½®æ¥ç¦ç”¨æ­¤èƒ½åŠ›ï¼Œè¿™å°†ï¼š
- âœ… å‡å° bundle ä½“ç§¯çº¦ 3KB (gzipped)
- âœ… é¿å…ä¸å¿…è¦çš„ä¾èµ–æ³¨å…¥
- âœ… æ¶ˆé™¤æ½œåœ¨çš„ç‰ˆæœ¬å†²çªé£é™©

### å¦‚ä½•ç¦ç”¨ Router ä¾èµ–

ä½ å¯ä»¥é€šè¿‡ `bridge.enableBridgeRouter` é…ç½®æ¥æ§åˆ¶æ˜¯å¦åŒ…å«è·¯ç”±æ”¯æŒï¼š

```ts title="rsbuild.config.ts"
import { pluginModuleFederation } from '@module-federation/rsbuild-plugin';

export default {
  plugins: [
    pluginModuleFederation({
      name: 'host-app',
      remotes: {
        remote1: 'remote1@http://localhost:3001/mf-manifest.json',
      },
      bridge: {
        // ç¦ç”¨è·¯ç”±æ”¯æŒä»¥å‡å° bundle ä½“ç§¯
        enableBridgeRouter: false,
      },
    }),
  ],
};
```

:::tip é…ç½®è¡Œä¸º
- **`enableBridgeRouter: false`**: è‡ªåŠ¨ alias åˆ° `/base` å…¥å£ï¼ˆä¸åŒ…å« react-router-dom ä»£ç ï¼‰
- **`enableBridgeRouter: true`** æˆ– **`undefined`**: åŒ…å«è·¯ç”±æ”¯æŒï¼ˆé»˜è®¤è¡Œä¸ºï¼‰

:::

### ä½•æ—¶ç¦ç”¨ Routerï¼Ÿ

**ç¦ç”¨ router** (`enableBridgeRouter: false`) é€‚ç”¨äºï¼š
- âœ… åº”ç”¨ä¸ä½¿ç”¨ react-router
- âœ… æƒ³è¦æœ€å°åŒ– bundle ä½“ç§¯
- âœ… å¯ä»¥æ‰‹åŠ¨ç®¡ç† basenameï¼ˆå¦‚æœéœ€è¦ï¼‰

**ä¿æŒ router å¯ç”¨**ï¼ˆé»˜è®¤ï¼‰é€‚ç”¨äºï¼š
- âœ… åº”ç”¨ä½¿ç”¨ react-router
- âœ… éœ€è¦è‡ªåŠ¨ basename æ³¨å…¥
- âœ… éœ€è¦è·¯ç”±ä¸Šä¸‹æ–‡é›†æˆ

### è¿ç§»ç¤ºä¾‹

#### è¿ç§»å‰ï¼šå¯ç”¨ Routerï¼ˆé»˜è®¤ï¼‰
```tsx
import { createRemoteAppComponent } from '@module-federation/bridge-react';

const RemoteApp = createRemoteAppComponent({
  loader: () => loadRemote('remote1/app'),
  loading: <div>Loading...</div>,
  fallback: ErrorBoundary,
});

// basename è‡ªåŠ¨ä»è·¯ç”±ä¸Šä¸‹æ–‡è·å–
<RemoteApp />
```

#### è¿ç§»åï¼šç¦ç”¨ Routerï¼ˆä¼˜åŒ–ï¼‰
```ts title="rsbuild.config.ts"
// é…ç½®
pluginModuleFederation({
  bridge: {
    enableBridgeRouter: false, // ç¦ç”¨ router
  },
})
```

```tsx
import { createRemoteAppComponent } from '@module-federation/bridge-react';

const RemoteApp = createRemoteAppComponent({
  loader: () => loadRemote('remote1/app'),
  loading: <div>Loading...</div>,
  fallback: ErrorBoundary,
});

// æ— éœ€ä¿®æ”¹ä»£ç ï¼æ’ä»¶ä¼šè‡ªåŠ¨ alias åˆ° /base å…¥å£
<RemoteApp basename="/" />  // å¦‚æœéœ€è¦ï¼Œæ‰‹åŠ¨ä¼ é€’ basename
```

:::info å·¥ä½œåŸç†
å½“è®¾ç½® `enableBridgeRouter: false` æ—¶ï¼ŒModule Federation æ’ä»¶ä¼šè‡ªåŠ¨è®¾ç½® webpack aliasï¼š
```
'@module-federation/bridge-react' â†’ '@module-federation/bridge-react/base'
```

è¿™æ„å‘³ç€ä½ çš„å¯¼å…¥ä¼šè‡ªåŠ¨è§£æåˆ°æ— è·¯ç”±ç‰ˆæœ¬ï¼Œæ— éœ€ä¿®æ”¹ä»»ä½•ä»£ç ï¼
:::

### éªŒè¯

ä½¿ç”¨ `enableBridgeRouter: false` æ„å»ºåï¼ŒéªŒè¯ bundle ä¸­ä¸åŒ…å« react-routerï¼š

```bash
# æ„å»ºåº”ç”¨
npm run build

# æ£€æŸ¥ bundle æ˜¯å¦åŒ…å« react-router
grep -r "react-router" dist/static/js/
# åº”è¯¥æ²¡æœ‰åŒ¹é…ç»“æœ
```