# åŠ è½½åº”ç”¨

æœ¬ç« å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ `createRemoteAppComponent` åœ¨å®¿ä¸»åº”ç”¨ä¸­åŠ è½½å’Œé›†æˆè¿œç¨‹ React åº”ç”¨ã€‚

## ä»€ä¹ˆæ˜¯ createRemoteAppComponentï¼Ÿ

`createRemoteAppComponent` æ˜¯ React Bridge çš„æ ¸å¿ƒ APIï¼Œç”¨äºåœ¨å®¿ä¸»åº”ç”¨ä¸­åŠ è½½è¿œç¨‹ React åº”ç”¨ã€‚å®ƒå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

- **ğŸš€ è‡ªåŠ¨æ‡’åŠ è½½** - è¿œç¨‹åº”ç”¨ä¼šåœ¨éœ€è¦æ—¶æ‰å¼€å§‹åŠ è½½
- **ğŸ”§ ç”Ÿå‘½å‘¨æœŸç®¡ç†** - è‡ªåŠ¨å¤„ç†ç»„ä»¶çš„æŒ‚è½½å’Œå¸è½½
- **ğŸ›£ï¸ è·¯ç”±é›†æˆ** - æ— ç¼é›†æˆ React Routerï¼Œæ”¯æŒ basename æ³¨å…¥
- **âš¡ é”™è¯¯å¤„ç†** - å†…ç½®åŠ è½½å¤±è´¥å’Œè¿è¡Œæ—¶é”™è¯¯å¤„ç†æœºåˆ¶
- **ğŸ¨ æ ·å¼éš”ç¦»** - æ”¯æŒç»„ä»¶çº§æ ·å¼å’Œç±»åé…ç½® 


## å®‰è£…

import { PackageManagerTabs } from '@theme';

<PackageManagerTabs
  command={{
    npm: 'npm install @module-federation/bridge-react@latest',
    yarn: 'yarn add @module-federation/bridge-react@latest',
    pnpm: 'pnpm add @module-federation/bridge-react@latest',
  }}
/>
## åŸºæœ¬ä½¿ç”¨

### æ­¥éª¤ 1: é…ç½®è¿œç¨‹æ¨¡å—

åœ¨å®¿ä¸»åº”ç”¨çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œæ·»åŠ è¿œç¨‹åº”ç”¨çš„é…ç½®ï¼š

:::tip æ„å»ºå·¥å…·æ”¯æŒ
ä»¥ä¸‹ç¤ºä¾‹ä½¿ç”¨ Rsbuild é…ç½®ï¼Œè¯·æ ¹æ®æ‚¨ä½¿ç”¨çš„æ„å»ºå·¥å…·è¿›è¡Œç›¸åº”è°ƒæ•´ï¼š
- **Rsbuild**: `@module-federation/rsbuild-plugin`
- **Rspack**: `@module-federation/enhanced/rspack`
- **Webpack**: `@module-federation/enhanced/webpack`
- **Vite**: `@module-federation/vite`

:::


```ts
// rsbuild.config.ts
import { pluginModuleFederation } from '@module-federation/rsbuild-plugin';
import { defineConfig } from '@rsbuild/core';

export default defineConfig({
  plugins: [
    pluginModuleFederation({
      name: 'host-app',
      remotes: {
        'remote1': 'remote1@http://localhost:3001/remoteEntry.js',
      },
    }),
  ],
});
```

### æ­¥éª¤ 2: åˆ›å»ºè¿œç¨‹ç»„ä»¶

#### 2.1 å®šä¹‰åŠ è½½å’Œé”™è¯¯ç»„ä»¶

é¦–å…ˆï¼Œåˆ›å»ºåŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†ç»„ä»¶ï¼š

```tsx
// ./src/components/RemoteComponents.tsx
import React from 'react';

// åŠ è½½çŠ¶æ€ç»„ä»¶
export const LoadingComponent = () => (
  <div style={{ padding: '20px', textAlign: 'center' }}>
    <div>è¿œç¨‹åº”ç”¨åŠ è½½ä¸­...</div>
  </div>
);

// é”™è¯¯å›é€€ç»„ä»¶
export const ErrorFallback = ({ error }: { error: Error }) => (
  <div style={{ padding: '20px', border: '1px solid #ff6b6b', borderRadius: '8px' }}>
    <h3>è¿œç¨‹åº”ç”¨åŠ è½½å¤±è´¥</h3>
    <p>é”™è¯¯è¯¦æƒ…: {error.message}</p>
    <button onClick={() => window.location.reload()}>
      é‡æ–°åŠ è½½é¡µé¢
    </button>
  </div>
);
```

#### 2.2 åˆ›å»ºè¿œç¨‹åº”ç”¨ç»„ä»¶

ä½¿ç”¨ `createRemoteAppComponent` åˆ›å»ºè¿œç¨‹ç»„ä»¶ï¼š

```tsx
// ./src/remotes/Remote1App.tsx
import { createRemoteAppComponent } from '@module-federation/bridge-react';
import { loadRemote } from '@module-federation/runtime';
import { LoadingComponent, ErrorFallback } from '../components/RemoteComponents';

export const Remote1App = createRemoteAppComponent({
  loader: () => loadRemote('remote1/export-app'),
  loading: LoadingComponent,
  fallback: ErrorFallback,
});
```

#### 2.3 ä¸»åº”ç”¨è·¯ç”±é…ç½®

åœ¨ä¸»åº”ç”¨ä¸­é…ç½®è·¯ç”±ï¼š

```tsx
// ./src/App.tsx
import React from 'react';
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import { Remote1App } from './remotes/Remote1App';

// å®¿ä¸»åº”ç”¨é¦–é¡µç»„ä»¶
const HomePage = () => (
  <div style={{ padding: '20px' }}>
    <h1>å®¿ä¸»åº”ç”¨é¦–é¡µ</h1>
    <p>è¿™æ˜¯å®¿ä¸»åº”ç”¨çš„é¦–é¡µå†…å®¹</p>
  </div>
);

const App = () => {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/" element={<HomePage />} />
        <Route
          path="/remote1/*"
          // ä½¿ç”¨ Remote1App ç»„ä»¶, å°†ä¼šè¢«æ‡’åŠ è½½
          Component={() => (
            <Remote1App
              // å¯è®¾ç½® className å’Œ style æ ·å¼ï¼Œå°†è‡ªåŠ¨æ³¨å…¥åˆ°ç»„ä»¶ä¸Š
              className={styles.remote1}
              style={{ color: 'red' }}
              // name å’Œ age ä¸ºè¿œç¨‹ç»„ä»¶ props, å°†è‡ªåŠ¨é€ä¼ åˆ°è¿œç¨‹ç»„ä»¶
              name={'Ming'}
              age={12}
              // å¯è®¾ç½® ref, å°†è‡ªåŠ¨è½¬å‘åˆ°è¿œç¨‹ç»„ä»¶ï¼Œå¯è·å– ref å¯¹è±¡æ“ä½œ dom
              ref={ref}
            />
          )}
        />
      </Routes>
    </BrowserRouter>
  );
};

export default App;
```

## è¿œç¨‹ç»„ä»¶ Props

### è·¯ç”±ç›¸å…³å±æ€§

- **`basename`**: è®¾ç½®è¿œç¨‹åº”ç”¨çš„åŸºç¡€è·¯å¾„
- **`memoryRoute`**: å†…å­˜è·¯ç”±é…ç½®ï¼Œç”¨äºå°†å­åº”ç”¨è·¯ç”±ä½œä¸º memoryRouter æ§åˆ¶

### æ ·å¼å±æ€§

- **`style`**: React.CSSProperties - è®¾ç½®ç»„ä»¶æ ·å¼
- **`className`**: string - è®¾ç½®ç»„ä»¶ç±»å

### å¼•ç”¨æ”¯æŒ

- **`ref`**: React.Ref\<HTMLDivElement\> - è½¬å‘å¼•ç”¨åˆ°å†…éƒ¨å®¹å™¨å…ƒç´ ï¼Œå¯ç”¨äº DOM æ“ä½œ

### æ€§èƒ½ä¼˜åŒ–å±æ€§

- **`disableRerender`**: boolean - ç¦ç”¨å®¿ä¸»åº”ç”¨ props å˜åŒ–æ—¶çš„é‡æ–°æ¸²æŸ“ï¼ˆé»˜è®¤ï¼šfalseï¼‰

### æ•°æ®ä¼ é€’

- **`props`**: ä¼ é€’ç»™è¿œç¨‹ç»„ä»¶çš„å±æ€§å¯¹è±¡
- æˆ–è€…ç›´æ¥ä¼ é€’å±æ€§ï¼Œå¦‚ `userId={'123'}`

## createRemoteAppComponent API å‚è€ƒ

### å‡½æ•°ç­¾å

```tsx
function createRemoteAppComponent<T = Record<string, unknown>, E extends keyof T = keyof T>(
  config: RemoteComponentParams<T, E>
): React.ForwardRefExoticComponent<
  Omit<RemoteComponentProps<T>, "ref"> & React.RefAttributes<HTMLDivElement>
>
```

### RemoteComponentParams\<T, E\>

é…ç½®å‚æ•°æ¥å£ï¼š

```tsx
interface RemoteComponentParams<T = Record<string, unknown>, E extends keyof T = keyof T> {
  // è¿œç¨‹æ¨¡å—åŠ è½½å™¨
  loader: () => Promise<T>;
  
  // åŠ è½½çŠ¶æ€æ˜¾ç¤ºå†…å®¹
  loading: React.ReactNode;
  
  // é”™è¯¯å›é€€ç»„ä»¶
  fallback: React.ComponentType<{ error: Error }>;
  
  // å¯¼å‡ºåç§°ï¼ˆå¯é€‰ï¼‰
  export?: E;
  
  // ä¼ é€’ç»™è¿œç¨‹ç»„ä»¶çš„å±æ€§ï¼ˆå¯é€‰ï¼‰
  props?: T;
}
```

### RemoteComponentProps\<T\>

è¿”å›ç»„ä»¶çš„å±æ€§æ¥å£ï¼š

```tsx
interface RemoteComponentProps<T = Record<string, unknown>> {
  // ä¼ é€’ç»™è¿œç¨‹ç»„ä»¶çš„å±æ€§
  props?: T;
  
  // é”™è¯¯å›é€€ç»„ä»¶
  fallback?: React.ComponentType<{ error: Error }>;
  
  // åŠ è½½çŠ¶æ€æ˜¾ç¤ºå†…å®¹
  loading?: React.ReactNode;
  
  // è·¯ç”±åŸºç¡€è·¯å¾„
  basename?: string;
  
  // å†…å­˜è·¯ç”±é…ç½®
  memoryRoute?: {
    entryPath: string;
    initialState?: Record<string, unknown>;
  };
  
  // æ ·å¼å±æ€§
  style?: React.CSSProperties;
  className?: string;
  
  // æ€§èƒ½ä¼˜åŒ–ï¼šç¦ç”¨å®¿ä¸» props å˜åŒ–æ—¶çš„é‡æ–°æ¸²æŸ“
  disableRerender?: boolean;
  
  // å…¶ä»–è‡ªå®šä¹‰å±æ€§
  [key: string]: unknown;
}
```

### å‚æ•°è¯¦è§£

### loader

- **ç±»å‹**: `() => Promise<T>`
- **å¿…éœ€**: æ˜¯
- **ä½œç”¨**: ç”¨äºåŠ è½½è¿œç¨‹æ¨¡å—çš„å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ª Promiseï¼Œè¯¥ Promise è§£æä¸ºè¿œç¨‹æ¨¡å—å¯¹è±¡
- **ç¤ºä¾‹**:
  ```tsx
  loader: () => loadRemote('remote1/export-app')
  loader: () => import('remote1/export-app')
  ```

### loading

- **ç±»å‹**: `React.ReactNode`
- **å¿…éœ€**: æ˜¯
- **ä½œç”¨**: åœ¨è¿œç¨‹åº”ç”¨åŠ è½½æœŸé—´æ˜¾ç¤ºçš„åŠ è½½å†…å®¹ï¼Œå¯ä»¥æ˜¯ç»„ä»¶ã€å…ƒç´ æˆ–å­—ç¬¦ä¸²
- **ç¤ºä¾‹**:
  ```tsx
  loading: <div>Loading...</div>
  loading: 'Loading remote app...'
  loading: <Spinner />
  ```

### fallback

- **ç±»å‹**: `React.ComponentType<{ error: Error }>`
- **å¿…éœ€**: æ˜¯
- **ä½œç”¨**: å½“è¿œç¨‹åº”ç”¨åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºçš„é”™è¯¯å›é€€ç»„ä»¶ï¼Œä¼šæ¥æ”¶é”™è¯¯å¯¹è±¡ä½œä¸º `error` å±æ€§
- **ç¤ºä¾‹**:
  ```tsx
  fallback: ({ error }) => <div>Error: {error.message}</div>
  fallback: ErrorBoundaryComponent
  ```

### export

- **ç±»å‹**: `E extends keyof T` (æ³›å‹çº¦æŸï¼Œé€šå¸¸æ˜¯ `string`)
- **å¿…éœ€**: å¦
- **é»˜è®¤å€¼**: `'default'`
- **ä½œç”¨**: æŒ‡å®šè¦ä½¿ç”¨çš„è¿œç¨‹æ¨¡å—å¯¼å‡ºåç§°
- **ç¤ºä¾‹**:
  
  å‡è®¾è¿œç¨‹æ¨¡å—æœ‰ä»¥ä¸‹å¯¼å‡ºï¼š
  ```tsx
  // è¿œç¨‹æ¨¡å—çš„å¯¼å‡º
  export default App;           // é»˜è®¤å¯¼å‡º
  export const provider = App;  // å‘½åå¯¼å‡º provider
  export const dashboard = Dashboard; // å‘½åå¯¼å‡º dashboard
  ```
  
  åœ¨å®¿ä¸»åº”ç”¨ä¸­å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š
  ```tsx
  // ä½¿ç”¨é»˜è®¤å¯¼å‡ºï¼ˆå¯ä»¥çœç•¥ export å‚æ•°ï¼‰
  createRemoteAppComponent({
    loader: () => loadRemote('remote1/export-app'),
    // export: 'default' // å¯ä»¥çœç•¥ï¼Œé»˜è®¤å°±æ˜¯ 'default'
  })
  
  // ä½¿ç”¨å‘½åå¯¼å‡º provider
  createRemoteAppComponent({
    loader: () => loadRemote('remote1/export-app'),
    export: 'provider'
  })
  
    // ä½¿ç”¨å‘½åå¯¼å‡º dashboard
  createRemoteAppComponent({
    loader: () => loadRemote('remote1/export-app'),
    export: 'dashboard'
  })
  ```

## æ€§èƒ½ä¼˜åŒ–

### ä½¿ç”¨ `disableRerender` é˜²æ­¢ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“

é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“å®¿ä¸»åº”ç”¨çš„ props å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè¿œç¨‹åº”ç”¨ä¼šé‡æ–°æ¸²æŸ“ã€‚å¦‚æœæ‚¨çš„è¿œç¨‹åº”ç”¨ç‹¬ç«‹ç®¡ç†è‡ªå·±çš„çŠ¶æ€ï¼Œä¸éœ€è¦å“åº”å®¿ä¸» props çš„å˜åŒ–ï¼Œå¯ä»¥ä½¿ç”¨ `disableRerender` å±æ€§æ¥ä¼˜åŒ–æ€§èƒ½ã€‚

#### ä½•æ—¶ä½¿ç”¨ `disableRerender`

âœ… **é€‚ç”¨åœºæ™¯ï¼š**
- è¿œç¨‹åº”ç”¨ä¸ä¾èµ–å®¿ä¸»åº”ç”¨çš„ props
- è¿œç¨‹åº”ç”¨ç‹¬ç«‹ç®¡ç†è‡ªå·±çš„çŠ¶æ€
- è¿œç¨‹åº”ç”¨æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ SPAï¼Œæœ‰è‡ªå·±çš„è·¯ç”±
- æ€§èƒ½è¦æ±‚è¾ƒé«˜ï¼Œéœ€è¦é¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“

âŒ **ä¸é€‚ç”¨åœºæ™¯ï¼š**
- è¿œç¨‹åº”ç”¨éœ€è¦å“åº”å®¿ä¸» props çš„å˜åŒ–
- è¿œç¨‹åº”ç”¨éœ€è¦æ˜¾ç¤ºå®¿ä¸»ä¼ é€’çš„æ•°æ®
- éœ€è¦å®æ—¶æ›´æ–°æ¥è‡ªå®¿ä¸»çš„æ•°æ®

#### åŸºæœ¬ç”¨æ³•

```tsx
import { createRemoteAppComponent } from '@module-federation/bridge-react';
import { loadRemote } from '@module-federation/runtime';

const Remote1App = createRemoteAppComponent({
  loader: () => loadRemote('remote1/export-app'),
  loading: LoadingComponent,
  fallback: ErrorFallback,
});

function App() {
  const [count, setCount] = useState(0);
  
  return (
    <div>
      {/* å®¿ä¸»çŠ¶æ€å˜åŒ–ä¸ä¼šè§¦å‘ Remote1App é‡æ–°æ¸²æŸ“ */}
      <button onClick={() => setCount(c => c + 1)}>
        å®¿ä¸»è®¡æ•°: {count}
      </button>
      
      <Remote1App 
        disableRerender={true}  // å¯ç”¨ä¼˜åŒ–
        name="ç”¨æˆ·å"
        userId={123}
      />
    </div>
  );
}
```

#### ä¸ React Router é…åˆä½¿ç”¨

:::warning é‡è¦æç¤º
ä½¿ç”¨ `disableRerender` æ—¶ï¼Œå¿…é¡»é¿å…åœ¨è·¯ç”±ä¸­ä½¿ç”¨å†…è”å‡½æ•°ç»„ä»¶ï¼Œå¦åˆ™ä¼šå¯¼è‡´ç»„ä»¶åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶è¢«å¸è½½å’Œé‡æ–°æŒ‚è½½ï¼Œä½¿ä¼˜åŒ–å¤±æ•ˆã€‚
:::

âŒ **é”™è¯¯ç¤ºä¾‹ï¼šå†…è”å‡½æ•°ç»„ä»¶**

```tsx
<Routes>
  {/* é”™è¯¯ï¼šæ¯æ¬¡æ¸²æŸ“éƒ½åˆ›å»ºæ–°çš„ç»„ä»¶ç±»å‹ */}
  <Route 
    path="/remote1/*" 
    Component={() => <Remote1App disableRerender={true} />} 
  />
</Routes>
```

âœ… **æ­£ç¡®ç¤ºä¾‹ï¼šæå–ç»„ä»¶**

```tsx
// æ–¹æ¡ˆ 1: æå–ä¸ºå‘½åç»„ä»¶
const Remote1Route = () => {
  return <Remote1App disableRerender={true} />;
};

<Routes>
  <Route path="/remote1/*" Component={Remote1Route} />
</Routes>

// æ–¹æ¡ˆ 2: åŒ…å«æœ¬åœ°çŠ¶æ€
const Remote1Route = () => {
  const [localCount, setLocalCount] = useState(0);
  
  return (
    <div>
      <button onClick={() => setLocalCount(c => c + 1)}>
        æœ¬åœ°è®¡æ•°: {localCount}
      </button>
      <Remote1App 
        disableRerender={true}
        basename="/remote1"
      />
    </div>
  );
};

<Routes>
  <Route path="/remote1/*" Component={Remote1Route} />
</Routes>
```

#### æ³¨æ„äº‹é¡¹

1. **åˆå§‹ props ä»ç„¶æœ‰æ•ˆ**
   ```tsx
   // è¿™äº›åˆå§‹ props ä¼šåœ¨é¦–æ¬¡æ¸²æŸ“æ—¶åº”ç”¨
   <Remote1App 
     disableRerender={true}
     userId={123}      // é¦–æ¬¡æ¸²æŸ“æ—¶ä½¿ç”¨
     theme="dark"      // é¦–æ¬¡æ¸²æŸ“æ—¶ä½¿ç”¨
   />
   // åç»­ userId æˆ– theme å˜åŒ–ä¸ä¼šæ›´æ–°è¿œç¨‹åº”ç”¨
   ```

2. **å…³é”® props ä»ä¼šè§¦å‘é‡æ–°æ¸²æŸ“**
   ```tsx
   // å³ä½¿å¯ç”¨äº† disableRerenderï¼Œè¿™äº› props å˜åŒ–ä»ä¼šè§¦å‘é‡æ–°æ¸²æŸ“
   <Remote1App 
     disableRerender={true}
     moduleName="remote1/app"  // å˜åŒ–ä¼šè§¦å‘é‡æ–°æ¸²æŸ“
     basename="/app"           // å˜åŒ–ä¼šè§¦å‘é‡æ–°æ¸²æŸ“
     memoryRoute={{...}}       // å˜åŒ–ä¼šè§¦å‘é‡æ–°æ¸²æŸ“
   />
   ```

3. **å¸è½½ä¼šæ¸…ç†çŠ¶æ€**
   ```tsx
   // ç»„ä»¶å¸è½½åï¼Œä¸‹æ¬¡æŒ‚è½½ä¼šè¢«è§†ä¸ºé¦–æ¬¡æ¸²æŸ“
   {showRemote && <Remote1App disableRerender={true} />}
   ```

#### é«˜çº§æ¨¡å¼ï¼šäº‹ä»¶é€šä¿¡

å¦‚æœéœ€è¦åœ¨ç¦ç”¨é‡æ–°æ¸²æŸ“çš„æƒ…å†µä¸‹ä¸è¿œç¨‹åº”ç”¨é€šä¿¡ï¼Œå¯ä»¥ä½¿ç”¨äº‹ä»¶æ€»çº¿ï¼š

```tsx
import EventEmitter from 'events';

// åˆ›å»ºäº‹ä»¶æ€»çº¿
const eventBus = new EventEmitter();

// å®¿ä¸»åº”ç”¨
function HostApp() {
  const [userId, setUserId] = useState(1);
  
  // é€šè¿‡äº‹ä»¶é€šçŸ¥è¿œç¨‹åº”ç”¨
  const handleUserChange = (newUserId) => {
    setUserId(newUserId);
    eventBus.emit('userChanged', { userId: newUserId });
  };
  
  return (
    <div>
      <button onClick={() => handleUserChange(2)}>åˆ‡æ¢ç”¨æˆ·</button>
      <Remote1App 
        disableRerender={true}
        eventBus={eventBus}  // ä¼ é€’ä¸€æ¬¡
      />
    </div>
  );
}

// è¿œç¨‹åº”ç”¨å†…éƒ¨
function RemoteApp({ eventBus }) {
  const [userId, setUserId] = useState(1);
  
  useEffect(() => {
    const handler = (data) => setUserId(data.userId);
    eventBus.on('userChanged', handler);
    return () => eventBus.off('userChanged', handler);
  }, [eventBus]);
  
  return <div>å½“å‰ç”¨æˆ·: {userId}</div>;
}
```