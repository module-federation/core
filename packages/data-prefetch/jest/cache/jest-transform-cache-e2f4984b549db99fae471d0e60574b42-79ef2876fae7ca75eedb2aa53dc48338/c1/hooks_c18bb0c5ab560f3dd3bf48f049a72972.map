{"version":3,"sources":["/Users/bytedance/WebstormProjects/universe/packages/data-prefetch/src/react/hooks.ts"],"sourcesContent":["import { useEffect, useState } from 'react';\nimport type { defer } from 'react-router';\n\nimport logger from '../logger';\nimport { MFDataPrefetch, type prefetchOptions } from '../prefetch';\nimport { prefetch } from '../universal';\nimport { getScope } from '../common/runtime-utils';\nimport { useFirstMounted } from './utils';\n\ntype refetchParams = any;\ntype DeferredData = ReturnType<typeof defer>;\ntype prefetchReturnType<T> = [\n  Promise<T>,\n  (refetchParams?: refetchParams) => void,\n];\n\ntype UsePrefetchOptions = prefetchOptions & {\n  deferId?: string;\n};\n\nexport const usePrefetch = <T>(\n  options: UsePrefetchOptions,\n): prefetchReturnType<T> => {\n  const isFirstMounted = useFirstMounted();\n  if (isFirstMounted) {\n    const startTiming = performance.now();\n    logger.info(\n      `2. Start Get Prefetch Data: ${options.id} - ${\n        options.functionId || 'default'\n      } - ${startTiming}`,\n    );\n  }\n  const { id, functionId, deferId } = options;\n  const prefetchInfo = {\n    id,\n    functionId,\n  };\n  const mfScope = getScope();\n\n  let state;\n  const prefetchResult = prefetch(options);\n  if (deferId) {\n    if (prefetchResult instanceof Promise) {\n      state = (prefetchResult as Promise<DeferredData>).then(\n        (deferredData) => deferredData.data[deferId],\n      );\n    } else {\n      state = (prefetchResult as DeferredData).data[deferId];\n    }\n  } else {\n    state = prefetchResult;\n  }\n  const [prefetchState, setPrefetchState] = useState<Promise<T>>(\n    state as Promise<T>,\n  );\n  const prefetchInstance = MFDataPrefetch.getInstance(mfScope);\n\n  useEffect(() => {\n    const useEffectTiming = performance.now();\n    logger.info(\n      `3. Start Execute UseEffect: ${options.id} - ${\n        options.functionId || 'default'\n      } - ${useEffectTiming}`,\n    );\n\n    return () => {\n      prefetchInstance?.markOutdate(prefetchInfo, true);\n    };\n  }, []);\n\n  const refreshExecutor = (refetchParams?: refetchParams) => {\n    const refetchOptions = {\n      ...options,\n    };\n    if (refetchParams) {\n      refetchOptions.refetchParams = refetchParams;\n    }\n    prefetchInstance?.markOutdate(prefetchInfo, true);\n    const newVal = prefetch(refetchOptions) as Promise<DeferredData>;\n    let newState;\n    if (deferId) {\n      if (newVal instanceof Promise) {\n        newState = newVal.then((deferredData) => deferredData.data[deferId]);\n      } else {\n        newState = (newVal as DeferredData).data[deferId];\n      }\n    } else {\n      newState = newVal;\n    }\n\n    setPrefetchState(newState as Promise<T>);\n  };\n\n  return [prefetchState, refreshExecutor];\n};\n"],"names":["usePrefetch","options","isFirstMounted","useFirstMounted","startTiming","performance","now","logger","info","id","functionId","deferId","prefetchInfo","mfScope","getScope","state","prefetchResult","prefetch","Promise","then","deferredData","data","prefetchState","setPrefetchState","useState","prefetchInstance","MFDataPrefetch","getInstance","useEffect","useEffectTiming","markOutdate","refreshExecutor","refetchParams","refetchOptions","newVal","newState"],"mappings":";;;;+BAoBaA;;;eAAAA;;;uBApBuB;+DAGjB;0BACkC;2BAC5B;8BACA;uBACO;;;;;;AAazB,MAAMA,cAAc,CACzBC;IAEA,MAAMC,iBAAiBC,IAAAA,sBAAe;IACtC,IAAID,gBAAgB;QAClB,MAAME,cAAcC,YAAYC,GAAG;QACnCC,eAAM,CAACC,IAAI,CACT,CAAC,4BAA4B,EAAEP,QAAQQ,EAAE,CAAC,GAAG,EAC3CR,QAAQS,UAAU,IAAI,UACvB,GAAG,EAAEN,YAAY,CAAC;IAEvB;IACA,MAAM,EAAEK,EAAE,EAAEC,UAAU,EAAEC,OAAO,EAAE,GAAGV;IACpC,MAAMW,eAAe;QACnBH;QACAC;IACF;IACA,MAAMG,UAAUC,IAAAA,sBAAQ;IAExB,IAAIC;IACJ,MAAMC,iBAAiBC,IAAAA,mBAAQ,EAAChB;IAChC,IAAIU,SAAS;QACX,IAAIK,0BAA0BE,SAAS;YACrCH,QAAQ,AAACC,eAAyCG,IAAI,CACpD,CAACC,eAAiBA,aAAaC,IAAI,CAACV,QAAQ;QAEhD,OAAO;YACLI,QAAQ,AAACC,eAAgCK,IAAI,CAACV,QAAQ;QACxD;IACF,OAAO;QACLI,QAAQC;IACV;IACA,MAAM,CAACM,eAAeC,iBAAiB,GAAGC,IAAAA,eAAQ,EAChDT;IAEF,MAAMU,mBAAmBC,wBAAc,CAACC,WAAW,CAACd;IAEpDe,IAAAA,gBAAS,EAAC;QACR,MAAMC,kBAAkBxB,YAAYC,GAAG;QACvCC,eAAM,CAACC,IAAI,CACT,CAAC,4BAA4B,EAAEP,QAAQQ,EAAE,CAAC,GAAG,EAC3CR,QAAQS,UAAU,IAAI,UACvB,GAAG,EAAEmB,gBAAgB,CAAC;QAGzB,OAAO;YACLJ,kBAAkBK,YAAYlB,cAAc;QAC9C;IACF,GAAG,EAAE;IAEL,MAAMmB,kBAAkB,CAACC;QACvB,MAAMC,iBAAiB;YACrB,GAAGhC,OAAO;QACZ;QACA,IAAI+B,eAAe;YACjBC,eAAeD,aAAa,GAAGA;QACjC;QACAP,kBAAkBK,YAAYlB,cAAc;QAC5C,MAAMsB,SAASjB,IAAAA,mBAAQ,EAACgB;QACxB,IAAIE;QACJ,IAAIxB,SAAS;YACX,IAAIuB,kBAAkBhB,SAAS;gBAC7BiB,WAAWD,OAAOf,IAAI,CAAC,CAACC,eAAiBA,aAAaC,IAAI,CAACV,QAAQ;YACrE,OAAO;gBACLwB,WAAW,AAACD,OAAwBb,IAAI,CAACV,QAAQ;YACnD;QACF,OAAO;YACLwB,WAAWD;QACb;QAEAX,iBAAiBY;IACnB;IAEA,OAAO;QAACb;QAAeS;KAAgB;AACzC"}